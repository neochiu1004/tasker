<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Command Center V7.5 (Smart Paste)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; user-select: none; touch-action: manipulation; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-checkbox { appearance: none; background-color: #334155; width: 1.2em; height: 1.2em; border: 1px solid #475569; border-radius: 0.25em; display: grid; place-content: center; }
        .custom-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); transition: 120ms transform ease-in-out; }
        .custom-checkbox:checked { background-color: #2563eb; border-color: #2563eb; }
        .custom-checkbox:checked::before { transform: scale(1); }
        .scroll-mt-header { scroll-margin-top: 190px; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#0f172a', card: '#1e293b', input: '#334155', border: '#334155', text: '#f8fafc', subtext: '#94a3b8', } } } } }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- MAIN APP -->
    <div id="main-app" class="w-full max-w-lg mx-auto space-y-6 p-4 md:p-8 pb-32 relative">
        
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-dark-bg/95 backdrop-blur-md pt-2 pb-4 -mt-2 -mx-2 px-2 transition-all duration-300">
            <div class="flex flex-col gap-3 bg-dark-card border border-dark-border p-3 rounded-xl shadow-lg relative overflow-hidden">
                <div class="absolute top-2 right-2 flex items-center gap-2">
                    <button onclick="openDataManagementModal()" class="px-2 py-1 bg-dark-bg/50 rounded border border-white/5 text-[10px] text-dark-subtext hover:text-white hover:bg-white/10 transition-colors flex items-center gap-1 group" title="資料管理">
                        <i data-lucide="database" class="w-3 h-3 group-hover:text-amber-400"></i>
                    </button>
                    <span class="px-2 py-1 bg-dark-bg/50 rounded border border-white/5 text-[10px] text-dark-subtext font-mono">OFFLINE</span>
                </div>

                <div class="flex justify-between items-center mt-1">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/50">
                            <i data-lucide="command" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h1 class="font-bold text-sm tracking-wide text-white flex items-center gap-2">COMMAND CTR V7.5</h1>
                            <div class="flex items-center gap-2 text-[10px] text-dark-subtext font-mono">
                                <span id="header-time-text" class="text-emerald-400 font-bold">--:--:--</span>
                                <span>•</span>
                                <span id="date-text">--/--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex bg-dark-bg p-1 rounded-lg border border-dark-border overflow-x-auto no-scrollbar">
                    <button id="btn-view-tracker" onclick="switchView('tracker')" class="flex-1 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm flex items-center justify-center gap-1"><i data-lucide="list-todo" class="w-3 h-3"></i> 任務</button>
                    <button id="btn-view-mutual" onclick="switchView('mutual')" class="flex-1 ml-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white border border-purple-500/30 flex items-center justify-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> 互助</button>
                </div>
            </div>
        </header>

        <!-- TRACKER VIEW -->
        <div id="view-tracker" class="view-section space-y-6 scroll-mt-header min-h-[40vh]">
            <div class="flex justify-between items-end">
                <h2 class="text-sm font-bold text-dark-subtext tracking-wider uppercase whitespace-nowrap mr-2">日常任務清單</h2>
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar justify-end w-full">
                    <button onclick="toggleSelectAll()" id="btn-select-all" class="text-xs bg-dark-card border border-dark-border hover:bg-white/5 text-dark-subtext hover:text-white px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0"><i data-lucide="check-square" class="w-3 h-3"></i> 全選</button>
                    <button onclick="deleteSelectedTasks()" id="btn-delete-selected" class="hidden text-xs bg-red-500/10 border border-red-500/20 hover:bg-red-500 hover:text-white text-red-500 px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0"><i data-lucide="trash-2" class="w-3 h-3"></i> 刪除</button>
                </div>
            </div>
            
            <div id="tracker-list" class="space-y-3 pb-8"></div>
            <div id="tracker-empty" class="py-12 text-center opacity-40 select-none hidden">
                <i data-lucide="cloud-off" class="w-12 h-12 mx-auto mb-3 text-dark-subtext opacity-50 block"></i>
                <p class="text-xs text-dark-subtext uppercase tracking-widest font-bold">目前沒有任務</p>
            </div>
        </div>

        <div class="h-px bg-gradient-to-r from-transparent via-dark-border to-transparent my-8 opacity-50"></div>
        
        <!-- MUTUAL VIEW -->
        <div id="view-mutual" class="view-section space-y-6 scroll-mt-header min-h-[40vh]">
            <div class="flex justify-between items-start mb-4 shrink-0">
                <div>
                    <h2 class="text-sm font-bold text-dark-subtext tracking-wider uppercase mb-1 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-purple-400"></i> 互助簽到</h2>
                    <p class="text-xs text-dark-subtext">資料儲存於本地瀏覽器。</p>
                </div>
                <div class="flex gap-2">
                     <button onclick="openMutualSettingsModal()" class="text-dark-subtext hover:text-white p-1 rounded hover:bg-white/10" title="設定"><i data-lucide="settings" class="w-5 h-5"></i></button>
                     <button onclick="showResetMenu()" class="text-dark-subtext hover:text-orange-400 p-1 rounded hover:bg-white/10" title="清空"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div id="mutual-quick-helper" class="bg-dark-input/50 rounded-lg p-3 border border-dark-border shrink-0">
                <p class="text-[10px] font-bold text-blue-400 uppercase mb-2 flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> 一鍵標記</p>
                <div id="mutual-helper-buttons" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="mutual-list" class="space-y-4 overflow-y-auto no-scrollbar pb-2"></div>
        </div>
    </div>

    <!-- FAB GROUP -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-4 items-center">
        <!-- CR-006: Smart Paste FAB -->
        <button id="fab-smart-paste" onclick="openSmartPasteMenu()" class="w-12 h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-full shadow-xl shadow-purple-900/50 flex items-center justify-center transition-all hover:scale-110 active:scale-95" title="快速貼上連結"><i data-lucide="link" class="w-5 h-5"></i></button>
        <!-- Existing Add Task FAB -->
        <button id="fab-new-task" onclick="openTrackerModal()" class="w-14 h-14 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full shadow-2xl shadow-emerald-900/50 flex items-center justify-center transition-all hover:scale-110 active:scale-95 group"><i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition-transform duration-300"></i></button>
    </div>

    <!-- Smart Paste Action Sheet (CR-006) -->
    <div id="smart-paste-modal" class="fixed inset-0 z-50 hidden flex items-end justify-center sm:items-center p-0 sm:p-4 bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border-t sm:border border-dark-border rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-transform animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="link" class="w-5 h-5 text-purple-400"></i><span>快速分配連結</span></h3>
                <button onclick="closeSmartPasteMenu()" class="text-dark-subtext hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="text-xs font-bold text-dark-subtext uppercase mb-1 block">將此連結分配給...</label>
                <div class="relative">
                    <input type="text" id="smart-paste-preview" class="w-full bg-dark-input border border-dark-border rounded-lg pl-9 pr-3 py-2 text-white text-sm font-mono focus:border-purple-500 focus:outline-none transition-colors" placeholder="請貼上連結..." oninput="handleSmartInput(this.value)">
                    <div class="absolute left-3 top-2.5 text-dark-subtext"><i data-lucide="globe" class="w-4 h-4"></i></div>
                </div>
                <p id="smart-paste-status" class="text-[10px] text-amber-400 mt-1 h-4"></p>
            </div>

            <div class="max-h-[50vh] overflow-y-auto no-scrollbar grid grid-cols-2 gap-2" id="smart-paste-list">
                <!-- User buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- Tracker Modal -->
    <div id="tracker-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="edit-3" class="w-5 h-5 text-blue-400"></i><span>編輯任務</span></h3>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-dark-subtext uppercase mb-1 block">名稱</label><input type="text" id="modal-name" class="w-full bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition-colors"></div>
                <div>
                    <label class="text-xs font-bold text-dark-subtext uppercase mb-1 block">URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="modal-url" onpaste="handlePasteInput(event, this)" placeholder="貼上連結..." class="flex-1 min-w-0 bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white text-sm font-mono focus:border-blue-500 focus:outline-none transition-colors">
                        <button onclick="document.getElementById('modal-url').value=''" class="bg-red-500/10 border border-red-500/30 text-red-400 hover:text-white hover:bg-red-500 rounded-lg px-3 transition-colors flex items-center justify-center"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <button type="button" onclick="pasteToUrl()" class="bg-dark-input border border-dark-border hover:bg-white/5 text-dark-subtext hover:text-white rounded-lg px-3 transition-colors flex items-center justify-center shadow-sm"><i data-lucide="clipboard-paste" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-dark-subtext uppercase mb-1 flex items-center gap-2"><span>開啟時間</span></label>
                    <div class="relative"><input type="time" id="modal-schedule" class="w-full bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white text-sm font-mono focus:border-blue-500 focus:outline-none transition-colors"><div class="absolute right-3 top-2 pointer-events-none text-dark-subtext"><i data-lucide="clock" class="w-4 h-4"></i></div></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="closeTrackerModal()" class="py-2.5 text-xs font-bold text-dark-subtext hover:bg-white/5 rounded-lg transition-colors">取消</button>
                <button onclick="saveTrackerTask()" class="py-2.5 text-xs font-bold bg-blue-600 text-white hover:bg-blue-500 rounded-lg shadow-lg transition-colors">儲存任務</button>
            </div>
        </div>
    </div>

    <!-- Mutual Settings Modal -->
    <div id="mutual-settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity overflow-y-auto">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 relative max-h-[90vh] flex flex-col">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-purple-400"></i><span>互助設定</span></h3>
            <div class="flex-1 flex flex-col space-y-4">
                <div>
                    <label class="text-xs font-bold text-white uppercase mb-2 block flex justify-between"><span>目標次數</span><span class="text-emerald-400 font-mono" id="target-display">3</span></label>
                    <input type="number" id="mutual-target-input" value="3" min="1" class="w-full bg-dark-input border border-dark-border rounded px-3 py-2 text-white text-sm focus:border-purple-500 focus:outline-none transition-colors">
                </div>
                <div>
                    <label class="text-xs font-bold text-white uppercase mb-2 block">編輯名單 (每行一個)</label>
                    <textarea id="mutual-names-input" class="w-full h-32 bg-dark-input border border-dark-border rounded px-3 py-2 text-white text-sm focus:border-purple-500 focus:outline-none resize-none" placeholder="Name 1&#10;Name 2"></textarea>
                </div>
                <button onclick="saveMutualConfig()" class="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg transition-colors shadow-lg">儲存設定</button>
                <button onclick="closeMutualSettingsModal()" class="w-full py-2 text-dark-subtext hover:text-white font-bold rounded-lg transition-colors">取消</button>
            </div>
        </div>
    </div>

    <!-- Reset Menu Modal -->
    <div id="reset-menu-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="rotate-ccw" class="w-5 h-5 text-orange-400"></i><span>重置選項</span></h3>
            <div class="space-y-3">
                <button onclick="resetRound()" class="w-full py-3 bg-red-900/20 border border-red-500/30 hover:bg-red-900/40 text-red-400 font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> 全部重置</button>
                <button onclick="closeResetMenu()" class="w-full py-3 text-dark-subtext hover:text-white font-bold rounded-lg transition-colors">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Data Management Modal -->
    <div id="data-management-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="database" class="w-5 h-5 text-amber-400"></i><span>資料管理</span></h3>
            <div class="space-y-4">
                <div class="bg-dark-card border border-dark-border rounded-lg p-4">
                    <h4 class="text-sm font-bold text-white mb-2">匯出備份</h4>
                    <button onclick="exportData()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> 下載備份</button>
                </div>

                <div class="bg-dark-card border border-dark-border rounded-lg p-4">
                    <h4 class="text-sm font-bold text-white mb-2">匯入還原</h4>
                    <input type="file" id="import-file-input" accept=".json" onchange="importData(event)" class="hidden">
                    <button onclick="document.getElementById('import-file-input').click()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> 選擇檔案</button>
                </div>
            </div>
            <button onclick="closeDataManagementModal()" class="w-full mt-6 py-2 text-dark-subtext hover:text-white font-bold rounded-lg transition-colors">關閉</button>
        </div>
    </div>


    <!-- APP LOGIC -->
    <script>
        // --- 1. CONFIGURATION & STATE ---
        const LOCAL_STORAGE_KEY_TASKS = 'cmd_offline_tasks';
        const LOCAL_STORAGE_KEY_MUTUAL = 'cmd_offline_mutual';
        const LOCAL_STORAGE_KEY_VIEW = 'cmd_offline_last_view'; 

        let trackerData = [];
        let mutualData = { target: 3, names: [], users: {} }; 
        let editingId = null; 
        let selectedTrackerIds = new Set();
        let currentView = 'tracker'; 
        let tempSmartUrl = ''; // CR-006
        
        // --- 2. LOCAL STORAGE OPERATIONS ---
        function loadData() {
            const storedTasks = localStorage.getItem(LOCAL_STORAGE_KEY_TASKS);
            if (storedTasks) {
                try {
                    trackerData = JSON.parse(storedTasks).sort((a, b) => b.createdAt - a.createdAt);
                } catch (e) {
                    console.error("Error loading tasks", e);
                    trackerData = [];
                }
            }
            const storedMutual = localStorage.getItem(LOCAL_STORAGE_KEY_MUTUAL);
            if (storedMutual) {
                try {
                    Object.assign(mutualData, JSON.parse(storedMutual));
                    Object.keys(mutualData.users || {}).forEach(name => {
                        delete mutualData.users[name].todayHelper;
                    });
                } catch (e) {
                    console.error("Error loading mutualData", e);
                }
            }
        }
        
        function saveTasks() {
            localStorage.setItem(LOCAL_STORAGE_KEY_TASKS, JSON.stringify(trackerData));
            renderTracker();
        }

        function saveMutualData() {
            localStorage.setItem(LOCAL_STORAGE_KEY_MUTUAL, JSON.stringify(mutualData));
            renderMutualList();
        }
        
        // --- 3. HELPER FUNCTIONS ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
        function extractUrl(text) { 
            if(!text) return '';
            const m = text.match(/(https?:\/\/[^\s]+)/); 
            return m ? m[0] : '';
        }
        window.extractUrl = extractUrl;

        function pad(n) { return String(n).padStart(2, '0'); }
        function formatTimeWithSeconds(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
        function getTaipeiDate() { return new Intl.DateTimeFormat('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date()); }

        function showToast(msg, type='info') {
            console.log(`[Action Complete] ${msg}`);
            return;
        }

        function openUrl(url) { 
            if(!url) return; 
            window.open(url.startsWith('http')?url:'https://'+url, '_blank'); 
        }
        window.openUrl = openUrl;

        function handlePasteInput(e, inputEl) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const clean = extractUrl(text);
            inputEl.value = clean || '';
            inputEl.dispatchEvent(new Event('input', { bubbles: true }));
        }
        window.handlePasteInput = handlePasteInput;

        async function getClipboardText() {
            try {
                return await navigator.clipboard.readText();
            } catch (err) {
                console.error('Failed to read clipboard', err);
                return ''; // Return empty string on failure, handle in UI
            }
        }

        window.pasteToUrl = async () => {
            const text = await getClipboardText();
            if(text) {
                const clean = extractUrl(text);
                const input = document.getElementById('modal-url');
                if(input) {
                    input.value = clean || text;
                    if(!clean) confirm('未偵測到有效網址');
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            } else {
                confirm('無法讀取剪貼簿，請手動貼上');
            }
        };

        window.pasteToMutual = async (elemId, name) => {
            const text = await getClipboardText();
            if (text) {
                const clean = extractUrl(text);
                const input = document.getElementById(elemId);
                if (input && clean) {
                    input.value = clean;
                    updateMutualUrl(name, clean);
                }
            } else {
                confirm('無法讀取剪貼簿，請手動貼上');
            }
        };

        window.quickPaste = async (id) => {
            const text = await getClipboardText();
            const clean = extractUrl(text);
            if (clean) {
                const index = trackerData.findIndex(t => t.id === id);
                if (index !== -1) {
                    trackerData[index].url = clean;
                    saveTasks();
                    showToast('已更新連結', 'success');
                }
            } else {
                confirm('未偵測到有效網址');
            }
        };

        window.clearTrackerUrl = (id) => {
             if(!confirm('確定要清除此連結？')) return;
             const index = trackerData.findIndex(t => t.id === id);
             if (index !== -1) {
                trackerData[index].url = '';
                saveTasks();
             }
        };

        window.toggleTrackerSelection = (id) => {
            if(selectedTrackerIds.has(id)) selectedTrackerIds.delete(id);
            else selectedTrackerIds.add(id);
            renderTracker();
        };

        window.toggleSelectAll = () => {
            if(trackerData.length > 0 && trackerData.every(t => selectedTrackerIds.has(t.id))) {
                selectedTrackerIds.clear();
            } else {
                trackerData.forEach(t => selectedTrackerIds.add(t.id));
            }
            renderTracker();
        };

        window.deleteSelectedTasks = async () => {
            if(selectedTrackerIds.size === 0) return;
            if(!confirm(`確定要刪除選取的 ${selectedTrackerIds.size} 個項目嗎？`)) return;
            
            trackerData = trackerData.filter(t => !selectedTrackerIds.has(t.id));
            selectedTrackerIds.clear();
            saveTasks();
            showToast('已刪除項目', 'success');
        };

        // --- 4. TASK DATA OPERATIONS ---

        function updateTask(id, data) {
            const index = trackerData.findIndex(t => t.id === id);
            if (index !== -1) {
                trackerData[index] = { ...trackerData[index], ...data };
                saveTasks();
            }
        }
        window.updateTask = updateTask;


        // --- 5. MUTUAL DATA OPERATIONS ---
        
        function updateMutualUrl(name, url) {
            if (!mutualData.users[name]) mutualData.users[name] = { url: '', history: [] };
            mutualData.users[name].url = url.trim();
            saveMutualData();
        }
        window.updateMutualUrl = updateMutualUrl;

        window.resetRound = () => {
            if(!confirm('確定要重置所有人的簽到紀錄嗎？')) return;
            const names = mutualData.names || [];
            names.forEach(n => {
                if(mutualData.users[n]) mutualData.users[n].history = []; 
            });
            saveMutualData();
            document.getElementById('reset-menu-modal').classList.add('hidden');
            showToast('已重置互助紀錄', 'success');
        };

        window.toggleHistory = (targetName, helperName) => {
            if (targetName === helperName) return; 
            const u = mutualData.users[targetName];
            if(!u) return;
            if(!u.history) u.history = [];
            if(u.history.includes(helperName)) {
                u.history = u.history.filter(h => h !== helperName);
            } else {
                u.history.push(helperName);
            }
            saveMutualData();
        };
        
        window.markAllAsHelpedBy = (helperName) => {
            if(!confirm(`將所有人標記為已被 ${helperName} 幫助/簽到？`)) return;
            const names = mutualData.names || [];
            names.forEach(target => {
                if (target === helperName) return; 
                const u = mutualData.users[target];
                if(!u) return;
                if(!u.history) u.history = [];
                if(!u.history.includes(helperName)) u.history.push(helperName);
            });
            saveMutualData();
            showToast('已一鍵標記', 'success');
        };

        window.saveMutualConfig = () => {
            const t = parseInt(document.getElementById('mutual-target-input').value);
            const nRaw = document.getElementById('mutual-names-input').value;
            const n = nRaw.split('\n').map(s=>s.trim()).filter(s=>s);
            
            mutualData.target = t > 0 ? t : 1;
            mutualData.names = n;
            
            const newUsers = {};
            n.forEach(name => {
                newUsers[name] = mutualData.users[name] || { url:'', history:[] };
                delete newUsers[name].todayHelper;
            });
            mutualData.users = newUsers;
            
            saveMutualData();
            closeMutualSettingsModal();
            document.getElementById('target-display').textContent = mutualData.target;
            showToast('已儲存互助設定', 'success');
        };

        // --- CR-006: Smart Paste Logic ---
        window.openSmartPasteMenu = async () => {
            const modal = document.getElementById('smart-paste-modal');
            const previewInput = document.getElementById('smart-paste-preview');
            const statusText = document.getElementById('smart-paste-status');
            const listContainer = document.getElementById('smart-paste-list');

            // 1. Try to read clipboard
            let clipboardText = '';
            try {
                clipboardText = await navigator.clipboard.readText();
                statusText.textContent = "已自動讀取剪貼簿";
            } catch (err) {
                console.log("Clipboard read failed, waiting for user input");
                statusText.textContent = "請手動貼上連結 (權限受限)";
            }

            // 2. Process text
            const url = extractUrl(clipboardText);
            previewInput.value = url || clipboardText; // Show url if found, else show raw text
            tempSmartUrl = url;

            if (url) {
                statusText.textContent = "偵測到有效連結！請選擇要分配的人員：";
                statusText.className = "text-[10px] text-emerald-400 mt-1 h-4 font-bold";
            } else if (clipboardText) {
                statusText.textContent = "未偵測到連結，請確認內容";
                statusText.className = "text-[10px] text-red-400 mt-1 h-4";
            }

            // 3. Render List
            const names = mutualData.names || [];
            if (names.length === 0) {
                listContainer.innerHTML = '<p class="col-span-2 text-center text-dark-subtext text-xs py-4">請先在設定中新增互助名單</p>';
            } else {
                listContainer.innerHTML = names.map(n => {
                    const hasUrl = mutualData.users[n]?.url ? true : false;
                    return `<button onclick="assignUrlToUser('${n}')" class="flex items-center justify-between px-3 py-3 bg-dark-input border border-dark-border rounded-lg hover:bg-purple-600 hover:text-white hover:border-purple-500 transition-all group">
                        <span class="text-sm font-bold truncate">${n}</span>
                        ${hasUrl ? '<i data-lucide="refresh-cw" class="w-3 h-3 text-dark-subtext group-hover:text-white/70"></i>' : '<i data-lucide="plus" class="w-3 h-3 text-dark-subtext group-hover:text-white"></i>'}
                    </button>`;
                }).join('');
                lucide.createIcons();
            }

            // 4. Show Modal
            modal.classList.remove('hidden');
        };

        window.closeSmartPasteMenu = () => {
            document.getElementById('smart-paste-modal').classList.add('hidden');
            tempSmartUrl = '';
        };

        window.handleSmartInput = (val) => {
            const url = extractUrl(val);
            tempSmartUrl = url;
            const statusText = document.getElementById('smart-paste-status');
            if (url) {
                statusText.textContent = "偵測到有效連結！請選擇人員：";
                statusText.className = "text-[10px] text-emerald-400 mt-1 h-4 font-bold";
            } else {
                statusText.textContent = "等待輸入...";
                statusText.className = "text-[10px] text-dark-subtext mt-1 h-4";
            }
        };

        window.assignUrlToUser = (name) => {
            if (!tempSmartUrl) {
                const inputVal = document.getElementById('smart-paste-preview').value;
                const extracted = extractUrl(inputVal);
                if (extracted) tempSmartUrl = extracted;
                else {
                    // Flash error
                    const statusText = document.getElementById('smart-paste-status');
                    statusText.textContent = "錯誤：無效的連結";
                    statusText.className = "text-[10px] text-red-500 mt-1 h-4 font-bold";
                    return;
                }
            }
            
            updateMutualUrl(name, tempSmartUrl);
            closeSmartPasteMenu();
            showToast(`已分配連結給 ${name}`, 'success');
            
            // Scroll to mutual view if not already there, to show the result
            if (currentView !== 'mutual') {
                switchView('mutual');
            } else {
                // If already in mutual view, maybe flash the card? (Optional polish)
            }
        };


        // --- 6. UI RENDER FUNCTIONS ---
        function renderTracker() {
            const listEl = document.getElementById('tracker-list');
            const empty = document.getElementById('tracker-empty');
            if(!listEl || !empty) return;

            if(trackerData.length === 0) { 
                listEl.innerHTML = ''; 
                empty.classList.remove('hidden'); 
                return; 
            }
            empty.classList.add('hidden');

            const allSel = trackerData.length && trackerData.every(l=>selectedTrackerIds.has(l.id)); 
            const hasSel = selectedTrackerIds.size > 0;
            const btnSelectAll = document.getElementById('btn-select-all');
            const btnDelete = document.getElementById('btn-delete-selected');

            if(btnSelectAll) btnSelectAll.className = `text-xs border px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0 ${allSel ? 'bg-blue-600 text-white border-blue-600' : 'bg-dark-card border-dark-border text-dark-subtext'}`;
            
            if(btnDelete) {
                if(hasSel) btnDelete.classList.remove('hidden'); 
                else btnDelete.classList.add('hidden');
            }

            listEl.innerHTML = trackerData.map(l => {
                const count = l.clicks || 0; 
                const sel = selectedTrackerIds.has(l.id);
                const dots = count > 5 ? `<span class="text-xs font-mono font-bold text-emerald-400">${count} 次點擊</span>` : Array(count).fill(`<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>`).join('');
                const sched = l.schedule ? `<div class="flex items-center gap-1.5 bg-dark-bg/50 px-2 py-1 rounded border border-white/5 ml-auto md:ml-0 md:mr-2"><i data-lucide="clock" class="w-3 h-3 ${l.executed?'text-dark-subtext':'text-amber-400'}"></i><span class="text-[10px] font-mono font-bold ${l.executed?'text-dark-subtext opacity-50 line-through':'text-amber-400'}">${l.schedule}</span></div>` : '';
                return `
                <div class="group relative bg-dark-card border border-dark-border hover:border-slate-500 rounded-xl p-3 flex items-center gap-3 transition-all select-none shadow-sm">
                    <div class="flex items-center justify-center pl-1 pr-2"><input type="checkbox" class="custom-checkbox" onchange="toggleTrackerSelection('${l.id}')" ${sel?'checked':''}></div>
                    <div class="flex-1 min-w-0"><div class="flex items-center justify-between mb-0.5"><h3 class="font-medium text-sm text-white truncate pr-2">${l.name}</h3>${sched}</div><div class="flex items-center gap-2 h-4">${dots}</div></div>
                    <div class="flex items-center gap-2">
                        <button onclick="if('${l.url}') openUrl('${l.url}'); else confirm('無連結'); window.updateTask('${l.id}', {clicks:((${l.clicks}||0)+1)})" class="bg-blue-600/10 hover:bg-blue-600 hover:text-white text-blue-400 border border-blue-500/30 rounded-lg px-3 py-2 text-xs font-bold transition-all active:scale-95 flex items-center gap-1">前往 <i data-lucide="external-link" class="w-3 h-3"></i></button>
                        <div class="flex flex-col gap-1 border-l border-white/5 pl-2">
                            <button onclick="quickPaste('${l.id}')" class="text-dark-subtext/60 hover:text-emerald-400 p-1" title="貼上覆蓋"><i data-lucide="clipboard-paste" class="w-3.5 h-3.5"></i></button>
                            ${l.url ? `<button onclick="clearTrackerUrl('${l.id}')" class="text-dark-subtext/60 hover:text-red-400 p-1" title="清除連結"><i data-lucide="link-2-off" class="w-3.5 h-3.5"></i></button>` : ''}
                            <button onclick="openTrackerModal(); window.setEditing('${l.id}', '${l.name}', '${l.url}', '${l.schedule||''}');" class="text-dark-subtext/60 hover:text-white p-1"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                            <button onclick="if(confirm('刪除任務 ${l.name}？')) window.deleteTask('${l.id}')" class="text-dark-subtext/60 hover:text-red-400 p-1"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderTracker = renderTracker;

        function deleteTask(id) {
            trackerData = trackerData.filter(t => t.id !== id);
            saveTasks();
            showToast('已刪除任務', 'success');
        }
        window.deleteTask = deleteTask;

        function renderMutualList() {
            const d = mutualData; 
            const names = d.names || [];
            const mutualHelperButtonsEl = document.getElementById('mutual-helper-buttons');
            const mutualListEl = document.getElementById('mutual-list');

            if(!mutualHelperButtonsEl || !mutualListEl) return;
            
            const targetDisplayEl = document.getElementById('target-display');
            if(targetDisplayEl) targetDisplayEl.textContent = d.target || 3;

            mutualHelperButtonsEl.innerHTML = names.map(n => `<button onclick="markAllAsHelpedBy('${n}')" class="px-3 py-1 bg-dark-card border border-dark-border rounded text-xs font-bold hover:bg-blue-600 hover:text-white transition-colors">${n}</button>`).join('');
            
            mutualListEl.innerHTML = names.map(n => {
                const u = d.users[n] || { url: '', history: [] };
                const historyCount = u.history ? u.history.length : 0;
                const target = d.target || 3;
                const done = historyCount >= target;
                const border = done ? 'border-amber-500/50 bg-amber-900/10' : 'border-dark-border bg-dark-card';
                
                const status = done 
                    ? `<span class="text-xs font-bold text-emerald-400 bg-emerald-400/10 px-2 py-0.5 rounded border border-emerald-400/20 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> 本輪完成</span>` 
                    : `<span class="text-xs font-bold text-dark-subtext bg-white/5 px-2 py-0.5 rounded">未達標</span>`;

                const helpers = names.filter(x => x !== n).map(h => { 
                    const active = u.history.includes(h);
                    return `<button onclick="toggleHistory('${n}', '${h}')" class="${active ? 'bg-emerald-600 text-white shadow shadow-emerald-900/50 border-emerald-500' : 'bg-dark-input text-dark-subtext border-dark-border'} border px-3 py-1.5 rounded text-xs font-bold transition-all active:scale-95 flex-1 min-w-[3rem]">${h}</button>`;
                }).join('');
                
                const selfHelp = names.filter(x => x === n).map(h => {
                    return `<button class="bg-red-900/10 text-red-400 border border-red-500/30 px-3 py-1.5 rounded text-xs font-bold opacity-50 cursor-not-allowed" title="不能幫自己簽到">${h} (排除)</button>`;
                }).join('');

                return `
                <div class="${border} border rounded-xl p-4 relative overflow-hidden">
                    ${done ? '<div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-amber-400/20 to-transparent rounded-bl-3xl -mr-4 -mt-4"></div>' : ''}
                    <div class="flex justify-between items-start mb-3 relative z-10">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-bold text-white text-lg">${n}</h4>
                                ${done ? '<span class="text-[10px] font-bold text-amber-900 bg-amber-400 px-2 py-0.5 rounded shadow-sm">本輪已完成</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${status}
                                <span class="text-[10px] font-mono text-dark-subtext bg-dark-bg px-1.5 rounded border border-white/5">
                                    累計: <span class="${done ? 'text-amber-400' : 'text-white'}">${historyCount}</span>/${target}
                                </span>
                            </div>
                        </div>
                        <button onclick="if(mutualData.users['${n}'].url) openUrl(mutualData.users['${n}'].url)" class="${u.url ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-dark-input text-dark-subtext cursor-not-allowed'} px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1 shadow-sm">前往 <i data-lucide="external-link" class="w-3 h-3"></i></button>
                    </div>
                    <div class="flex gap-2 mb-4 relative z-10">
                        <div class="relative flex-1"><input type="text" value="${u.url||''}" onpaste="handlePasteInput(event, this)" oninput="updateMutualUrl('${n}', extractUrl(this.value))" id="mutual-input-${n}" class="w-full bg-dark-input border border-dark-border rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="貼上連結..."></div>
                        <div class="flex gap-1">
                            <button onclick="pasteToMutual('mutual-input-${n}', '${n}')" class="bg-dark-input border border-dark-border px-3 rounded-lg text-dark-subtext hover:text-white hover:bg-white/5 transition-colors" title="貼上"><i data-lucide="clipboard-paste" class="w-4 h-4"></i></button>
                            <button onclick="updateMutualUrl('${n}', '')" class="bg-red-500/10 border border-red-500/30 px-3 rounded-lg text-red-400 hover:text-white hover:bg-red-500 transition-colors" title="清除連結"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="border-t border-white/5 pt-3 relative z-10">
                        <p class="text-[10px] font-bold text-dark-subtext uppercase mb-2">可幫助 ${n} 的人員</p>
                        <div class="flex flex-wrap gap-2">
                            ${helpers}
                            ${selfHelp}
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderMutualList = renderMutualList;


        // --- 7. MAIN LOGIC & LOOPS ---
        function switchView(viewId) {
            currentView = viewId;
            localStorage.setItem(LOCAL_STORAGE_KEY_VIEW, viewId);

            const isTracker = viewId === 'tracker';
            const btnTracker = document.getElementById('btn-view-tracker');
            const btnMutual = document.getElementById('btn-view-mutual');

            if (isTracker) {
                btnTracker.className = 'flex-1 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm flex items-center justify-center gap-1';
                btnMutual.className = 'flex-1 ml-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white border border-purple-500/30 flex items-center justify-center gap-1';
            } else {
                btnTracker.className = 'flex-1 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white border border-blue-500/30 flex items-center justify-center gap-1';
                btnMutual.className = 'flex-1 ml-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-purple-600 text-white shadow-sm flex items-center justify-center gap-1';
            }
            
            const target = document.getElementById('view-' + viewId);
            if(target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        window.switchView = switchView;


        function checkScheduledTasks(now) {
            const hm = pad(now.getHours()) + ':' + pad(now.getMinutes());
            trackerData.forEach(l => {
                if (l.schedule === hm && !l.executed) {
                    const index = trackerData.findIndex(t => t.id === l.id);
                    if (index !== -1) {
                        trackerData[index].executed = true;
                        trackerData[index].clicks = (trackerData[index].clicks || 0) + 1;
                        saveTasks();
                    }
                    window.open(l.url.startsWith('http')?l.url:'https://'+l.url, '_blank');
                }
            });
        }

        function updateTimerLoop() {
            const now = new Date();
            const headerTimeEl = document.getElementById('header-time-text');
            if (headerTimeEl) headerTimeEl.textContent = formatTimeWithSeconds(now);
            const dateTextEl = document.getElementById('date-text');
            if (dateTextEl) dateTextEl.textContent = getTaipeiDate();
            checkScheduledTasks(now);
        }
        window.updateTimerLoop = updateTimerLoop;

        // --- 8. UI EVENT HANDLERS ---
        function setEditing(id, name, url, schedule) {
            editingId = id;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="edit-3" class="w-5 h-5 text-blue-400"></i><span>編輯任務</span>`;
            document.getElementById('modal-name').value = name;
            document.getElementById('modal-url').value = url;
            document.getElementById('modal-schedule').value = schedule;
            document.getElementById('tracker-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        window.setEditing = setEditing;

        function closeTrackerModal() { document.getElementById('tracker-modal').classList.add('hidden'); editingId=null; }
        window.closeTrackerModal = closeTrackerModal;

        function openTrackerModal() {
            editingId = null;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="plus" class="w-5 h-5 text-emerald-400"></i><span>新增任務</span>`;
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-url').value = '';
            document.getElementById('modal-schedule').value = '';
            document.getElementById('tracker-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        window.openTrackerModal = openTrackerModal;

        function saveTrackerTask() {
            const name = document.getElementById('modal-name').value.trim();
            const raw = document.getElementById('modal-url').value.trim();
            const sch = document.getElementById('modal-schedule').value;
            if(!name) return;
            const clean = extractUrl(raw);
            const data = { name, url: clean, schedule: sch || null, executed: false, clicks: 0 };

            if(editingId) {
                updateTask(editingId, { ...data, executed: false }); 
                showToast('已更新任務', 'success');
            } else {
                const newTask = { id: generateId(), createdAt: Date.now(), ...data };
                trackerData.unshift(newTask);
                saveTasks();
                showToast('已新增任務', 'success');
            }
            document.getElementById('tracker-modal').classList.add('hidden');
        }
        window.saveTrackerTask = saveTrackerTask;
        
        window.openMutualSettingsModal = () => {
            document.getElementById('mutual-names-input').value = (mutualData.names || []).join('\n'); 
            document.getElementById('mutual-target-input').value = mutualData.target || 3; 
            document.getElementById('mutual-settings-modal').classList.remove('hidden'); 
            lucide.createIcons();
        };
        window.closeMutualSettingsModal = () => document.getElementById('mutual-settings-modal').classList.add('hidden');
        
        window.showResetMenu = () => document.getElementById('reset-menu-modal').classList.remove('hidden');
        window.closeResetMenu = () => document.getElementById('reset-menu-modal').classList.add('hidden');

        // --- 9. DATA MANAGEMENT FUNCTIONS ---

        window.openDataManagementModal = () => {
            document.getElementById('data-management-modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeDataManagementModal = () => {
            document.getElementById('data-management-modal').classList.add('hidden');
        };

        function exportData() {
            const data = {
                version: '7.5', // Bumped version
                tasks: localStorage.getItem(LOCAL_STORAGE_KEY_TASKS),
                mutual: localStorage.getItem(LOCAL_STORAGE_KEY_MUTUAL)
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const dateStr = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
            a.href = url;
            a.download = `CMD_backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('資料已匯出', 'success');
        }
        window.exportData = exportData;

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.tasks || !importedData.mutual) {
                        confirm('檔案格式錯誤或缺少任務/互助資料');
                        return;
                    }

                    localStorage.setItem(LOCAL_STORAGE_KEY_TASKS, importedData.tasks);
                    localStorage.setItem(LOCAL_STORAGE_KEY_MUTUAL, importedData.mutual);
                    
                    loadData();
                    renderTracker();
                    renderMutualList();
                    lucide.createIcons();
                    
                    closeDataManagementModal();
                    showToast('資料匯入成功！已還原備份。', 'success');

                } catch (error) {
                    console.error("Import Error:", error);
                    confirm('匯入失敗，請檢查檔案是否為有效的 JSON 格式。');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }
        window.importData = importData;


        // --- 10. INIT ---
        function initApp() {
            loadData();
            renderTracker();
            renderMutualList();
            lucide.createIcons();

            const lastView = localStorage.getItem(LOCAL_STORAGE_KEY_VIEW);
            if (lastView && lastView !== 'tracker') {
                switchView(lastView);
            } else {
                switchView('tracker');
            }
            setInterval(updateTimerLoop, 1000);
        }

        window.onload = initApp;

    </script>
</body>
</html>

