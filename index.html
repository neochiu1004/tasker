<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Command Center V5 - Fixed</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA1o7BjEcjZBEyjNKnVi5bknbkkJJSy0DI",
            authDomain: "task-71198.firebaseapp.com",
            projectId: "task-71198",
            storageBucket: "task-71198.firebasestorage.app",
            messagingSenderId: "192519078026",
            appId: "1:192519078026:web:b283a50108f54bbd6d6d73",
            measurementId: "G-29ZTR7DCJL"
        };

        const APP_ID_ROOT = 'my-ticket-app'; 
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase Init Error", error); }

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let currentWorkspaceId = localStorage.getItem('cmd_workspace_id') || '';
        let trackerData = [];
        let timerData = [];
        window.mutualData = { target: 3, names: [], users: {} }; 
        let isMutualLoaded = false;
        let editingId = null; 
        let selectedTrackerIds = new Set();

        // --- 3. AUTO-LOGIN CHECK ---
        const urlParams = new URLSearchParams(window.location.search);
        const urlSpaceId = urlParams.get('space_id');
        const shareUrl = urlParams.get('share_url');
        const shareTitle = urlParams.get('share_title');
        
        if (urlSpaceId) {
            currentWorkspaceId = urlSpaceId;
            localStorage.setItem('cmd_workspace_id', urlSpaceId);
        }

        // Store Share Data
        let pendingShare = null;
        if (shareUrl) {
            pendingShare = {
                url: shareUrl,
                title: shareTitle || 'Shared Link'
            };
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- 4. HELPER FUNCTIONS ---
        function extractUrl(text) { 
            if(!text) return '';
            const m = text.match(/(https?:\/\/[^\s]+)/); 
            return m ? m[0] : text; 
        }
        window.extractUrl = extractUrl;

        function pad(n) { return String(n).padStart(2, '0'); }
        function formatTime(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
        function formatTimeWithSeconds(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
        function getTaipeiDate() { return new Intl.DateTimeFormat('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date()); }

        function showToast(msg, type='info') {
            const t = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-600 border-emerald-500' : 'bg-blue-600 border-blue-500';
            t.className = `fixed top-6 left-1/2 -translate-x-1/2 ${color} text-white px-6 py-4 rounded-xl shadow-2xl z-[100] flex items-center gap-3 animate-bounce border-2 backdrop-blur-md`;
            t.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6"></i><span class="text-base font-bold tracking-wide">${msg}</span>`;
            document.body.appendChild(t); 
            lucide.createIcons(); 
            setTimeout(()=>t.remove(), 4000);
        }

        function openUrl(url) { 
            if(!url) return; 
            const win = window.open(url.startsWith('http')?url:'https://'+url, '_blank'); 
            if(!win) alert('Pop-up Blocked'); 
        }
        window.openUrl = openUrl;

        // --- 5. DATA OPERATIONS ---
        async function saveTaskToCloud(task) {
            const cols = getCollections();
            if(cols) await addDoc(cols.tasks, { ...task, createdAt: Date.now(), executed: false, clicks: 0 });
        }
        window.saveTaskToCloud = saveTaskToCloud;

        async function updateTaskInCloud(id, data) {
            const docRef = doc(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_cmd_tasks`, id);
            await updateDoc(docRef, data);
        }
        window.updateTaskInCloud = updateTaskInCloud;

        async function deleteTaskFromCloud(id) {
            const docRef = doc(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_cmd_tasks`, id);
            await deleteDoc(docRef);
        }
        window.deleteTaskFromCloud = deleteTaskFromCloud;

        async function saveTimerToCloud(timer) {
            const cols = getCollections();
            if(cols) await addDoc(cols.timers, { ...timer, endTime: timer.endTime, createdAt: Date.now() });
        }
        window.saveTimerToCloud = saveTimerToCloud;

        async function deleteTimerFromCloud(id) {
            const docRef = doc(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_cmd_timers`, id);
            await deleteDoc(docRef);
        }
        window.deleteTimerFromCloud = deleteTimerFromCloud;

        async function saveMutualToCloud(data) {
             const cols = getCollections();
             if(cols) await setDoc(cols.mutualDoc, data, { merge: true });
        }
        window.saveMutualToCloud = saveMutualToCloud;

        async function updateMutualUrl(name, url) {
            if (!window.mutualData.users[name]) window.mutualData.users[name] = { url: '', history: [], todayHelper: null };
            window.mutualData.users[name].url = url.trim();
            saveMutualToCloud(window.mutualData);
        }
        window.updateMutualUrl = updateMutualUrl;

        // --- 6. UI RENDER FUNCTIONS ---
        
        // Render Timers
        function renderTimers() {
            const tContainer = document.getElementById('timers-container');
            const tEmpty = document.getElementById('timer-empty');
            
            if(!tContainer || !tEmpty) return;

            if(!timerData.length) { 
                tContainer.innerHTML = ''; 
                tEmpty.classList.remove('hidden'); 
                return; 
            }
            tEmpty.classList.add('hidden');
            
            tContainer.innerHTML = timerData.map(t => {
                const total = t.totalSeconds || 60; 
                const percent = Math.max(0, (t.remaining / total) * 100); 
                const isDone = t.isFinished;
                const statusClass = isDone ? 'bg-red-500/10 border-red-500/30' : 'bg-dark-card border-dark-border';
                const progressColor = isDone ? 'bg-red-500' : 'bg-blue-500';
                const h = Math.floor(t.remaining / 3600), m = Math.floor((t.remaining % 3600) / 60), s = t.remaining % 60;
                const fmt = h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
                
                return `<div class="relative ${statusClass} border rounded-xl p-4 overflow-hidden transition-all group hover:border-slate-500 pr-12"><div class="absolute bottom-0 left-0 h-1 ${progressColor} transition-all duration-1000 opacity-60" style="width: ${percent}%"></div><div class="flex justify-between items-center relative z-10"><div class="flex items-center gap-4 overflow-hidden flex-1"><div class="w-12 h-12 flex-shrink-0 rounded-xl ${isDone ? 'bg-red-500/20' : 'bg-blue-500/10'} flex items-center justify-center border border-white/5">${isDone ? '<i data-lucide="bell" class="w-6 h-6 text-red-500 animate-bounce"></i>' : '<i data-lucide="timer" class="w-6 h-6 text-blue-400"></i>'}</div><div class="min-w-0 flex flex-col justify-center"><div class="font-medium text-xs text-dark-subtext truncate mb-1 uppercase tracking-wide flex items-center gap-1">${t.label}${t.hasDelay ? '<span class="text-[9px] text-amber-400 bg-amber-400/10 px-1 rounded border border-amber-400/20">BUFFER</span>' : ''}</div><div class="font-mono font-bold ${isDone ? 'text-red-400' : 'text-white'} text-2xl sm:text-3xl leading-none tracking-tight">${isDone ? 'TIME UP' : fmt}</div></div></div><div class="flex items-center gap-3"><div class="flex flex-col items-end justify-center pl-4 border-l border-white/10"><span class="text-[10px] font-bold text-dark-subtext uppercase tracking-wider mb-1">Ends At</span><span class="font-mono font-bold text-emerald-400 text-2xl sm:text-3xl leading-none">${formatTime(t.endTime)}</span></div><button onclick="deleteTimerFromCloud('${t.id}')" class="w-8 h-8 flex items-center justify-center border border-red-500/40 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all ml-1 shrink-0"><i data-lucide="x" class="w-5 h-5"></i></button></div></div></div>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderTimers = renderTimers;

        // Render Tracker
        function renderTracker() {
            const listEl = document.getElementById('tracker-list');
            const empty = document.getElementById('tracker-empty');
            
            if(!listEl || !empty) return;

            if(!trackerData.length) { 
                listEl.innerHTML = ''; 
                empty.classList.remove('hidden'); 
                return; 
            }
            empty.classList.add('hidden');

            const allSel = trackerData.length && trackerData.every(l=>selectedTrackerIds.has(l.id)); 
            const hasSel = selectedTrackerIds.size > 0;
            const btnSelectAll = document.getElementById('btn-select-all');
            const btnDelete = document.getElementById('btn-delete-selected');

            if(btnSelectAll) btnSelectAll.className = `text-xs border px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0 ${allSel ? 'bg-blue-600 text-white border-blue-600' : 'bg-dark-card border-dark-border text-dark-subtext'}`;
            if(btnDelete) {
                if(hasSel) btnDelete.classList.remove('hidden'); 
                else btnDelete.classList.add('hidden');
            }

            listEl.innerHTML = trackerData.map((l, idx) => {
                const count = l.clicks || 0; 
                const sel = selectedTrackerIds.has(l.id);
                const dots = count > 5 ? `<span class="text-xs font-mono font-bold text-emerald-400">${count} runs</span>` : Array(count).fill(`<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>`).join('');
                const sched = l.schedule ? `<div class="flex items-center gap-1.5 bg-dark-bg/50 px-2 py-1 rounded border border-white/5 ml-auto md:ml-0 md:mr-2"><i data-lucide="clock" class="w-3 h-3 ${l.executed?'text-dark-subtext':'text-amber-400'}"></i><span class="text-[10px] font-mono font-bold ${l.executed?'text-dark-subtext opacity-50 line-through':'text-amber-400'}">${l.schedule}</span></div>` : '';
                const hasUrl = !!l.url;
                return `
                <div class="group relative bg-dark-card border border-dark-border hover:border-slate-500 rounded-xl p-3 flex items-center gap-3 transition-all select-none shadow-sm">
                    <div class="flex items-center justify-center pl-1 pr-2"><input type="checkbox" class="custom-checkbox" onchange="toggleTrackerSelection('${l.id}')" ${sel?'checked':''}></div>
                    <div class="flex-1 min-w-0"><div class="flex items-center justify-between mb-0.5"><h3 class="font-medium text-sm text-white truncate pr-2">${l.name}</h3>${sched}</div><div class="flex items-center gap-2 h-4">${dots}</div></div>
                    <div class="flex items-center gap-2">
                        <button onclick="if('${l.url}') openUrl('${l.url}'); else alert('無連結'); window.updateTaskInCloud('${l.id}', {clicks:((${l.clicks}||0)+1)})" class="bg-blue-600/10 hover:bg-blue-600 hover:text-white text-blue-400 border border-blue-500/30 rounded-lg px-3 py-2 text-xs font-bold transition-all active:scale-95 flex items-center gap-1">GO <i data-lucide="external-link" class="w-3 h-3"></i></button>
                        <div class="flex flex-col gap-1 border-l border-white/5 pl-2">
                            <button onclick="quickPaste(${idx})" class="text-dark-subtext/60 hover:text-emerald-400 p-1" title="貼上覆蓋"><i data-lucide="clipboard-paste" class="w-3.5 h-3.5"></i></button>
                            ${l.url ? `<button onclick="clearTrackerUrl('${l.id}')" class="text-dark-subtext/60 hover:text-red-400 p-1" title="清除連結"><i data-lucide="link-2-off" class="w-3.5 h-3.5"></i></button>` : ''}
                            <button onclick="openTrackerModal(); window.setEditing('${l.id}', '${l.name}', '${l.url}', '${l.schedule||''}');" class="text-dark-subtext/60 hover:text-white p-1"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                            <button onclick="if(confirm('刪除？')) window.deleteTaskFromCloud('${l.id}')" class="text-dark-subtext/60 hover:text-red-400 p-1"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderTracker = renderTracker;

        // Render Mutual
        function renderMutualList() {
            const d = window.mutualData; 
            const names = d.names || [];
            const mutualHelperButtonsEl = document.getElementById('mutual-helper-buttons');
            const mutualListEl = document.getElementById('mutual-list');

            if(!mutualHelperButtonsEl || !mutualListEl) return;

            mutualHelperButtonsEl.innerHTML = names.map(n => `<button onclick="markAllAsHelpedBy('${n}')" class="px-3 py-1 bg-dark-card border border-dark-border rounded text-xs font-bold hover:bg-blue-600 hover:text-white transition-colors">${n}</button>`).join('');
            mutualListEl.innerHTML = names.map(n => {
                const u = d.users[n] || { url: '', history: [], todayHelper: null };
                const done = u.history.length >= (d.target||3);
                const border = done ? 'border-amber-500/50 bg-amber-900/10' : 'border-dark-border bg-dark-card';
                const status = u.todayHelper ? `<span class="text-xs font-bold text-emerald-400 bg-emerald-400/10 px-2 py-0.5 rounded border border-emerald-400/20 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> 已簽 (${u.todayHelper})</span>` : `<span class="text-xs font-bold text-dark-subtext bg-white/5 px-2 py-0.5 rounded">未簽</span>`;
                const helpers = names.filter(x => x !== n).map(h => {
                    const active = u.history.includes(h);
                    return `<button onclick="toggleHistory('${n}', '${h}')" class="${active ? 'bg-emerald-600 text-white shadow shadow-emerald-900/50 border-emerald-500' : 'bg-dark-input text-dark-subtext border-dark-border'} border px-3 py-1.5 rounded text-xs font-bold transition-all active:scale-95 flex-1 min-w-[3rem]">${h}</button>`;
                }).join('');
                return `
                <div class="${border} border rounded-xl p-4 relative overflow-hidden">
                    ${done ? '<div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-amber-400/20 to-transparent rounded-bl-3xl -mr-4 -mt-4"></div>' : ''}
                    <div class="flex justify-between items-start mb-3 relative z-10">
                        <div><div class="flex items-center gap-2 mb-1"><h4 class="font-bold text-white text-lg">${n}</h4>${done ? '<span class="text-[10px] font-bold text-amber-900 bg-amber-400 px-2 py-0.5 rounded shadow-sm">本輪完成</span>' : ''}</div><div class="flex items-center gap-2">${status}<span class="text-[10px] font-mono text-dark-subtext bg-dark-bg px-1.5 rounded border border-white/5">累計: <span class="${done ? 'text-amber-400' : 'text-white'}">${u.history.length}</span>/${d.target}</span></div></div>
                        <button onclick="if(window.mutualData.users['${n}'].url) openUrl(window.mutualData.users['${n}'].url)" class="${u.url ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-dark-input text-dark-subtext cursor-not-allowed'} px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1 shadow-sm">前往 <i data-lucide="external-link" class="w-3 h-3"></i></button>
                    </div>
                    <div class="flex gap-2 mb-4 relative z-10">
                        <div class="relative flex-1"><input type="text" value="${u.url||''}" oninput="updateMutualUrl('${n}', window.extractUrl(this.value))" id="mutual-input-${n}" class="w-full bg-dark-input border border-dark-border rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="貼上連結..."></div>
                        <div class="flex gap-1">
                            <button onclick="pasteToMutual('mutual-input-${n}', '${n}')" class="bg-dark-input border border-dark-border px-3 rounded-lg text-dark-subtext hover:text-white hover:bg-white/5 transition-colors"><i data-lucide="clipboard-paste" class="w-4 h-4"></i></button>
                            <button onclick="updateMutualUrl('${n}', '')" class="bg-red-500/10 border border-red-500/30 px-3 rounded-lg text-red-400 hover:text-white hover:bg-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="border-t border-white/5 pt-3 relative z-10"><div class="flex flex-wrap gap-2">${helpers}</div></div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        window.renderMutualList = renderMutualList;

        // --- 7. MAIN LOGIC & LOOPS ---

        function checkScheduledTasks(now) {
            const hm = pad(now.getHours()) + ':' + pad(now.getMinutes());
            trackerData.forEach(l => {
                if (l.schedule === hm && !l.executed) {
                    updateTaskInCloud(l.id, { executed: true, clicks: (l.clicks||0)+1 });
                    const win = window.open(l.url.startsWith('http')?l.url:'https://'+l.url, '_blank');
                    if(!win) { 
                        const popup = document.getElementById('popup-warning');
                        const icon = document.getElementById('popup-warning-icon');
                        if(popup) popup.classList.remove('hidden'); 
                        if(icon) icon.classList.remove('hidden'); 
                    }
                }
            });
        }

        function updateTimerLoop() {
            const now = new Date();
            
            // Safe DOM Updates
            const headerTimeEl = document.getElementById('header-time-text');
            if (headerTimeEl) headerTimeEl.textContent = formatTimeWithSeconds(now);
            
            const dateTextEl = document.getElementById('date-text');
            if (dateTextEl) dateTextEl.textContent = getTaipeiDate();
            
            const secBarEl = document.getElementById('seconds-bar');
            if (secBarEl) secBarEl.style.width = `${(now.getSeconds() / 60) * 100}%`;
            
            const secTextEl = document.getElementById('seconds-text');
            if (secTextEl) secTextEl.textContent = pad(now.getSeconds());
            
            checkScheduledTasks(now);

            // Timer update logic
            timerData.forEach(t => { 
                if(!(t.endTime instanceof Date)) t.endTime = new Date(t.endTime); 
                t.remaining = Math.max(0, Math.ceil((t.endTime - now) / 1000)); 
                t.isFinished = t.remaining <= 0; 
            });

            const active = timerData.filter(t => !t.isFinished).length;
            const activeCountEl = document.getElementById('active-count');
            if(activeCountEl) activeCountEl.textContent = active;
            
            const tasksBarEl = document.getElementById('tasks-bar');
            if(tasksBarEl) tasksBarEl.style.width = active > 0 ? '100%' : '0%';

            renderTimers();
        }
        window.updateTimerLoop = updateTimerLoop;

        // --- 8. AUTH & FIRESTORE SETUP ---
        function getCollections() {
            if (!currentWorkspaceId) return null;
            return {
                tasks: collection(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_cmd_tasks`),
                timers: collection(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_cmd_timers`),
                mutualDoc: doc(db, 'artifacts', APP_ID_ROOT, 'public', 'data', `${currentWorkspaceId}_mutual`, 'config')
            };
        }

        function initFirestoreListeners() {
            const cols = getCollections();
            if (!cols) return;

            onSnapshot(query(cols.tasks, orderBy('createdAt', 'desc')), (snapshot) => {
                trackerData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTracker();
            });

            onSnapshot(cols.timers, (snapshot) => {
                timerData = snapshot.docs.map(d => ({ id: d.id, ...d.data(), endTime: d.data().endTime ? d.data().endTime.toDate() : new Date() }));
                updateTimerLoop(); 
            });

            onSnapshot(cols.mutualDoc, (docSnap) => {
                if (docSnap.exists()) {
                    window.mutualData = docSnap.data();
                    renderMutualList();
                }
                if (!isMutualLoaded) {
                    isMutualLoaded = true;
                    checkIncomingShare(); 
                }
            });
            
            const wsDisplay = document.getElementById('workspace-id-display');
            if(wsDisplay) wsDisplay.textContent = currentWorkspaceId;
        }

        function checkIncomingShare() {
            if (!isMutualLoaded) return; 
            if (!pendingShare) return;

            const cleanUrl = extractUrl(pendingShare.url);
            const name = pendingShare.title.trim();
            const mutualNames = window.mutualData.names || [];
            const matchName = mutualNames.find(n => n.toLowerCase() === name.toLowerCase());

            if (matchName) {
                updateMutualUrl(matchName, cleanUrl);
                showToast(`已更新互助: ${matchName}`, 'success');
            } else {
                saveTaskToCloud({ name: name, url: cleanUrl, schedule: null });
                showToast(`已自動存入清單: ${name}`, 'success');
            }
            pendingShare = null;
        }

        // --- 9. UI EVENT HANDLERS ---
        function setEditing(id, name, url, schedule) {
            editingId = id;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="edit-3" class="w-5 h-5 text-blue-400"></i><span>Edit Task</span>`;
            document.getElementById('modal-name').value = name;
            document.getElementById('modal-url').value = url;
            document.getElementById('modal-schedule').value = schedule;
            document.getElementById('tracker-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        window.setEditing = setEditing;

        function closeTrackerModal() { document.getElementById('tracker-modal').classList.add('hidden'); editingId=null; }
        window.closeTrackerModal = closeTrackerModal;

        function openTrackerModal() {
            editingId = null;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="plus" class="w-5 h-5 text-emerald-400"></i><span>New Task</span>`;
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-url').value = '';
            document.getElementById('modal-schedule').value = '';
            document.getElementById('tracker-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        window.openTrackerModal = openTrackerModal;

        function saveTrackerTask() {
            const name = document.getElementById('modal-name').value.trim();
            const raw = document.getElementById('modal-url').value.trim();
            const sch = document.getElementById('modal-schedule').value;
            if(!name) return;
            const clean = extractUrl(raw);
            const data = { name, url: clean, schedule: sch || null };
            if(editingId) updateTaskInCloud(editingId, { ...data, executed: false }); else saveTaskToCloud(data);
            document.getElementById('tracker-modal').classList.add('hidden');
        }
        window.saveTrackerTask = saveTrackerTask;
        
        // Other Modals
        window.openMutualModal = () => { renderMutualList(); document.getElementById('mutual-settings').classList.add('hidden'); document.getElementById('mutual-list').classList.remove('hidden'); document.getElementById('mutual-modal').classList.remove('hidden'); lucide.createIcons(); };
        window.closeMutualModal = () => document.getElementById('mutual-modal').classList.add('hidden');
        window.toggleMutualSettings = () => { 
            const s = document.getElementById('mutual-settings'), l = document.getElementById('mutual-list');
            if (s.classList.contains('hidden')) { s.classList.remove('hidden'); l.classList.add('hidden'); document.getElementById('mutual-names-input').value = (window.mutualData.names || []).join('\n'); document.getElementById('mutual-target-input').value = window.mutualData.target || 3; } 
            else { s.classList.add('hidden'); l.classList.remove('hidden'); } 
        };
        window.showResetMenu = () => document.getElementById('reset-menu-modal').classList.remove('hidden');
        window.closeResetMenu = () => document.getElementById('reset-menu-modal').classList.add('hidden');

        // --- 10. AUTH LISTENER & INIT ---
        const switchLoginState = (isLoggedIn) => {
            const loginScreen = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');
            const fab = document.getElementById('fab-new-task');

            if (!loginScreen || !mainApp || !fab) return;

            if (isLoggedIn) {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                fab.classList.remove('hidden');
            } else {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                fab.classList.add('hidden');
            }
        };

        const initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { alert(e); } };

        window.handleLogin = (e) => {
            e.preventDefault();
            const inputId = document.getElementById('workspace-input').value.trim();
            if (!inputId) return alert("請輸入空間代碼");
            currentWorkspaceId = inputId;
            localStorage.setItem('cmd_workspace_id', inputId);
            switchLoginState(true);
            initFirestoreListeners();
        };

        window.handleLogout = () => {
            if(confirm('確定要登出嗎？')) {
                localStorage.removeItem('cmd_workspace_id');
                const url = new URL(window.location);
                url.searchParams.delete('space_id');
                window.history.pushState({}, '', url);
                window.location.reload();
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user && currentWorkspaceId) {
                switchLoginState(true);
                initFirestoreListeners();
                setTimeout(() => {
                    if (!isMutualLoaded) { 
                        isMutualLoaded = true; 
                        checkIncomingShare(); 
                    }
                }, 2000);
            } else if (user) {
                switchLoginState(false);
            }
        });

        // Start Loop
        setInterval(updateTimerLoop, 1000);
        
        // Timer Form
        const timerForm = document.getElementById('timer-form');
        if(timerForm) {
            timerForm.addEventListener('submit', (e) => { e.preventDefault(); const t = (parseInt(inputH.value)||0)*3600 + (parseInt(inputM.value)||0)*60 + (parseInt(inputS.value)||0) + (parseInt(globalDelayInput.value)||0)*60; if(t>0) window.saveTimerToCloud({ label: document.getElementById('t-label').value.trim()||'Task', endTime: new Date(Date.now()+t*1000), totalSeconds: t }); inputH.value=inputM.value=inputS.value=''; });
        }

        initAuth();
    </script>
</body>
</html>
