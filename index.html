<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Command Center V2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; 
            color: #e2e8f0;
            user-select: none;
            touch-action: manipulation; 
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Time Input Styling */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* Checkbox Styling */
        .custom-checkbox {
            appearance: none;
            background-color: #334155;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid #475569;
            border-radius: 0.25em;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .custom-checkbox:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Hide Scrollbar for Horizontal Scroll areas */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .view-section { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-focus-ring:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a', card: '#1e293b', input: '#334155',
                            border: '#334155', text: '#f8fafc', subtext: '#94a3b8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="w-full max-w-lg mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center bg-dark-card border border-dark-border p-3 rounded-xl shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/50">
                    <i data-lucide="command" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-wide text-white">DASHBOARD</h1>
                    <div class="flex items-center gap-2 text-[10px] text-dark-subtext font-mono">
                        <span id="header-time-text" class="text-emerald-400 font-bold">--:--:--</span>
                        <span>•</span>
                        <span id="date-text">--/--</span>
                    </div>
                </div>
            </div>

            <!-- Button Switcher -->
            <div class="flex bg-dark-bg p-1 rounded-lg border border-dark-border">
                <button id="btn-view-tracker" onclick="switchView('tracker')" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm flex items-center gap-1">
                    <i data-lucide="list-todo" class="w-3 h-3"></i> TRACKER
                </button>
                <button id="btn-view-timer" onclick="switchView('timer')" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all text-dark-subtext hover:text-white flex items-center gap-1">
                    <i data-lucide="timer" class="w-3 h-3"></i> TIMER
                </button>
            </div>
        </header>

        <!-- ==================== TRACKER VIEW (Default) ==================== -->
        <div id="view-tracker" class="view-section space-y-6">
            <div class="flex justify-between items-end">
                <h2 class="text-sm font-bold text-dark-subtext tracking-wider uppercase whitespace-nowrap mr-2">Daily Routine</h2>
                
                <!-- NEW: Buttons Toolbar with Horizontal Scroll support for small screens -->
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar justify-end w-full">
                    
                    <!-- NEW: Select All -->
                    <button onclick="toggleSelectAll()" id="btn-select-all" class="text-xs bg-dark-card border border-dark-border hover:bg-white/5 text-dark-subtext hover:text-white px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0">
                        <i data-lucide="check-square" class="w-3 h-3"></i> ALL
                    </button>
                    
                    <!-- NEW: Delete Selected (Hidden by default) -->
                    <button onclick="deleteSelectedTasks()" id="btn-delete-selected" class="hidden text-xs bg-red-500/10 border border-red-500/20 hover:bg-red-500 hover:text-white text-red-500 px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> DEL
                    </button>

                    <!-- Backup -->
                    <button onclick="copySelectedTasks()" class="text-xs bg-dark-card border border-dark-border hover:bg-white/5 text-dark-subtext hover:text-white px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0" title="Copy Selected to Clipboard">
                        <i data-lucide="copy" class="w-3 h-3"></i> BACKUP
                    </button>
                    
                    <!-- Restore -->
                    <button onclick="openRestoreModal()" class="text-xs bg-dark-card border border-dark-border hover:bg-white/5 text-purple-400 hover:text-white px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-sm shrink-0" title="Import from Backup">
                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i> RESTORE
                    </button>
                    
                    <!-- New Task -->
                    <button onclick="openTrackerModal()" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-md font-bold transition-colors flex items-center gap-1 shadow-lg shadow-emerald-900/20 shrink-0">
                        <i data-lucide="plus" class="w-3 h-3"></i> NEW
                    </button>
                </div>
            </div>
            
            <!-- Warning for Popups -->
            <div id="popup-warning" class="hidden bg-amber-500/10 border border-amber-500/20 rounded-lg p-3 flex items-start gap-3">
                <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500 mt-0.5 flex-shrink-0"></i>
                <div class="text-xs text-amber-200">
                    <strong class="block mb-1 text-amber-400">Pop-up Blocked</strong>
                    Your browser blocked the auto-open. Please allow pop-ups for this site in your browser settings.
                    <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="block mt-2 underline text-amber-400/70 hover:text-amber-400">Dismiss</button>
                </div>
            </div>

            <div id="tracker-list" class="space-y-3 pb-8"></div>
            <div id="tracker-empty" class="hidden py-12 text-center opacity-40 select-none">
                <i data-lucide="list-todo" class="w-12 h-12 mx-auto mb-3 text-dark-subtext"></i>
                <p class="text-xs text-dark-subtext uppercase tracking-widest font-bold">No Routine Tasks</p>
            </div>
        </div>

        <!-- ==================== TIMER VIEW ==================== -->
        <div id="view-timer" class="view-section hidden space-y-5">
            <!-- Stats Bar -->
            <div class="grid grid-cols-2 gap-4 text-xs font-mono">
                <div>
                    <div class="flex justify-between mb-1 text-dark-subtext">
                        <span>SYSTEM TIME</span>
                        <span id="seconds-text" class="text-blue-400">00</span>
                    </div>
                    <div class="h-1.5 w-full bg-dark-border rounded-full overflow-hidden">
                        <div id="seconds-bar" class="h-full bg-blue-500/80 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1 text-dark-subtext">
                        <span>ACTIVE TASKS</span>
                        <span id="active-count" class="text-white">0</span>
                    </div>
                    <div class="h-1.5 w-full bg-dark-border rounded-full overflow-hidden">
                        <div id="tasks-bar" class="h-full bg-emerald-500/80 w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>

            <!-- Global Delay Config -->
            <div class="bg-dark-card border border-dark-border rounded-lg p-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-2 text-amber-400">
                    <i data-lucide="hourglass" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase tracking-wider text-dark-subtext">Delay Buffer</span>
                </div>
                <div class="flex items-center bg-dark-bg border border-dark-border rounded px-2 py-1 gap-2 focus-within:border-amber-400 transition-colors">
                    <input type="number" id="global-delay" value="0" min="0" inputmode="numeric" 
                        class="bg-transparent text-right font-mono text-sm font-bold text-white w-12 outline-none" placeholder="0">
                    <span class="text-[10px] font-bold text-dark-subtext">MIN</span>
                </div>
            </div>

            <!-- Timer Input Form -->
            <form id="timer-form" class="space-y-3">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="plus" class="h-4 w-4 text-dark-subtext group-focus-within:text-blue-400"></i>
                    </div>
                    <input type="text" id="t-label" placeholder="New timer name..." autocomplete="off"
                        class="block w-full pl-10 pr-4 py-3 bg-dark-card border border-dark-border rounded-lg text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white transition-all shadow-sm">
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <div class="bg-dark-card border border-dark-border rounded-lg p-2 text-center input-focus-ring transition-colors">
                        <label class="text-[9px] text-dark-subtext font-bold block mb-1">HR</label>
                        <input type="number" id="t-h" placeholder="0" min="0" inputmode="numeric" pattern="[0-9]*" 
                            class="w-full bg-transparent text-center font-mono text-xl font-bold outline-none text-white placeholder-slate-700">
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-lg p-2 text-center input-focus-ring transition-colors">
                        <label class="text-[9px] text-dark-subtext font-bold block mb-1">MIN</label>
                        <input type="number" id="t-m" placeholder="0" min="0" max="59" inputmode="numeric" pattern="[0-9]*" 
                            class="w-full bg-transparent text-center font-mono text-xl font-bold outline-none text-white placeholder-slate-700">
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-lg p-2 text-center input-focus-ring transition-colors">
                        <label class="text-[9px] text-dark-subtext font-bold block mb-1">SEC</label>
                        <input type="number" id="t-s" placeholder="0" min="0" max="59" inputmode="numeric" pattern="[0-9]*" 
                            class="w-full bg-transparent text-center font-mono text-xl font-bold outline-none text-white placeholder-slate-700">
                    </div>
                    <button type="submit" id="t-submit" class="bg-blue-600 hover:bg-blue-500 text-white rounded-lg flex items-center justify-center transition-all shadow-lg shadow-blue-900/30 active:scale-95">
                        <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                    </button>
                </div>
            </form>

            <div class="border-t border-dark-border/50"></div>
            <div id="timers-container" class="space-y-4 pb-12"></div>
            
            <div id="timer-empty" class="hidden py-12 text-center opacity-40 select-none">
                <i data-lucide="clock" class="w-12 h-12 mx-auto mb-3 text-dark-subtext"></i>
                <p class="text-xs text-dark-subtext uppercase tracking-widest font-bold">No Active Timers</p>
            </div>
        </div>

    </div>

    <!-- Tracker Modal -->
    <div id="tracker-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-5 h-5 text-blue-400"></i>
                <span>Edit Task</span>
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-dark-subtext uppercase mb-1 block">Title</label>
                    <input type="text" id="modal-name" class="w-full bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition-colors">
                </div>
                <div>
                    <label class="text-xs font-bold text-dark-subtext uppercase mb-1 block">URL (Paste mixed text here)</label>
                    <div class="flex gap-2">
                        <input type="text" id="modal-url" placeholder="Paste link here..." class="flex-1 min-w-0 bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white text-sm font-mono focus:border-blue-500 focus:outline-none transition-colors">
                        <button type="button" onclick="pasteToUrl()" class="bg-dark-input border border-dark-border hover:bg-white/5 text-dark-subtext hover:text-white rounded-lg px-3 transition-colors flex items-center justify-center shadow-sm" title="Paste from Clipboard">
                            <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <!-- Schedule Time Input -->
                <div>
                    <label class="text-xs font-bold text-dark-subtext uppercase mb-1 flex items-center gap-2">
                        <span>Auto Open At (24h)</span>
                        <span class="text-[10px] text-emerald-400 font-normal normal-case ml-auto">Browser must allow pop-ups</span>
                    </label>
                    <div class="relative">
                        <input type="time" id="modal-schedule" class="w-full bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white text-sm font-mono focus:border-blue-500 focus:outline-none transition-colors">
                        <div class="absolute right-3 top-2 pointer-events-none text-dark-subtext">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-dark-subtext mt-1">Leave empty to disable auto-open.</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="closeTrackerModal()" class="py-2.5 text-xs font-bold text-dark-subtext hover:bg-white/5 rounded-lg transition-colors">CANCEL</button>
                <button onclick="saveTrackerTask()" class="py-2.5 text-xs font-bold bg-blue-600 text-white hover:bg-blue-500 rounded-lg shadow-lg transition-colors">SAVE CHANGE</button>
            </div>
        </div>
    </div>

    <!-- NEW: Restore Modal -->
    <div id="restore-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
        <div class="bg-dark-bg border border-dark-border rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="rotate-ccw" class="w-5 h-5 text-purple-400"></i>
                <span>Restore Tasks</span>
            </h3>
            <p class="text-xs text-dark-subtext mb-2">Paste your backup text here (Format: Title: URL)</p>
            <textarea id="restore-input" class="w-full h-32 bg-dark-input border border-dark-border rounded-lg px-3 py-2 text-white text-xs font-mono focus:border-purple-500 focus:outline-none transition-colors resize-none" placeholder="Task 1: https://...&#10;Task 2: https://..."></textarea>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="closeRestoreModal()" class="py-2.5 text-xs font-bold text-dark-subtext hover:bg-white/5 rounded-lg transition-colors">CANCEL</button>
                <button onclick="importTasks()" class="py-2.5 text-xs font-bold bg-purple-600 text-white hover:bg-purple-500 rounded-lg shadow-lg transition-colors">IMPORT</button>
            </div>
        </div>
    </div>

    <script>
        // --- Utilities ---
        const pad = (num) => String(num).padStart(2, '0');
        const formatTime = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        const formatTimeWithSeconds = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        const getTaipeiDate = () => new Intl.DateTimeFormat('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());

        // --- DOM Elements ---
        const viewTimer = document.getElementById('view-timer');
        const viewTracker = document.getElementById('view-tracker');
        const headerTime = document.getElementById('header-time-text');
        const headerDate = document.getElementById('date-text');
        const btnTracker = document.getElementById('btn-view-tracker');
        const btnTimer = document.getElementById('btn-view-timer');
        const popupWarning = document.getElementById('popup-warning');

        // Inputs
        const inputH = document.getElementById('t-h');
        const inputM = document.getElementById('t-m');
        const inputS = document.getElementById('t-s');
        const btnSubmit = document.getElementById('t-submit');
        const globalDelayInput = document.getElementById('global-delay');

        // --- Init Delay Buffer ---
        const savedDelay = localStorage.getItem('dashboard-global-delay');
        if (savedDelay) {
            globalDelayInput.value = savedDelay;
        }
        globalDelayInput.addEventListener('input', (e) => {
            localStorage.setItem('dashboard-global-delay', e.target.value);
        });

        // --- View Switcher Logic ---
        window.switchView = (viewName) => {
            if (viewName === 'timer') {
                viewTimer.classList.remove('hidden');
                viewTracker.classList.add('hidden');
                btnTimer.className = "px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm flex items-center gap-1";
                btnTracker.className = "px-3 py-1.5 rounded-md text-xs font-bold transition-all text-dark-subtext hover:text-white flex items-center gap-1";
            } else {
                viewTimer.classList.add('hidden');
                viewTracker.classList.remove('hidden');
                btnTracker.className = "px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-sm flex items-center gap-1";
                btnTimer.className = "px-3 py-1.5 rounded-md text-xs font-bold transition-all text-dark-subtext hover:text-white flex items-center gap-1";
            }
        };

        // --- Auto-Jump Input Logic ---
        const focusNext = (currentId) => {
            if (currentId === 't-h') inputM.focus();
            else if (currentId === 't-m') inputS.focus();
            else if (currentId === 't-s') btnSubmit.focus();
        };

        [inputH, inputM, inputS].forEach(input => {
            input.addEventListener('focus', function() { this.select(); });
            input.addEventListener('input', function() {
                const val = this.value;
                if (this.id !== 't-h' && val.length >= 2) focusNext(this.id);
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (this.id === 't-s' || (this.value && this.id !== 't-s')) {
                         if (this.id === 't-s') document.getElementById('timer-form').requestSubmit();
                         else focusNext(this.id);
                    }
                }
            });
        });

        // =======================
        // PASTE LOGIC
        // =======================
        window.pasteToUrl = async () => {
            try {
                const text = await navigator.clipboard.readText();
                const urlInput = document.getElementById('modal-url');
                urlInput.value = text;
                urlInput.focus();
                urlInput.classList.add('border-green-500');
                setTimeout(() => urlInput.classList.remove('border-green-500'), 500);
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                const urlInput = document.getElementById('modal-url');
                urlInput.focus();
                alert('瀏覽器安全性限制：請點擊輸入框並按下 Ctrl+V 貼上');
            }
        };

        // =======================
        // TIMER LOGIC
        // =======================
        let timers = [];
        const tContainer = document.getElementById('timers-container');
        const tEmpty = document.getElementById('timer-empty');
        
        function initTimers() {
            const saved = localStorage.getItem('dashboard-timers');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    timers = parsed.map(t => ({
                        ...t,
                        endTime: new Date(t.endTime)
                    }));
                } catch(e) { console.error('Error loading timers', e); }
            }
            updateTimerLoop(); 
        }

        function saveTimers() {
            localStorage.setItem('dashboard-timers', JSON.stringify(timers));
        }

        function updateTimerLoop() {
            const now = new Date();
            headerTime.textContent = formatTimeWithSeconds(now);
            headerDate.textContent = getTaipeiDate();

            const sec = now.getSeconds();
            const secRatio = (sec / 60) * 100;
            document.getElementById('seconds-bar').style.width = `${secRatio}%`;
            document.getElementById('seconds-text').textContent = pad(sec);
            
            checkScheduledTasks(now);

            timers.forEach(t => {
                const diff = t.endTime - now;
                t.remaining = Math.max(0, Math.ceil(diff / 1000));
                t.isFinished = t.remaining <= 0;
            });

            const active = timers.filter(t => !t.isFinished).length;
            document.getElementById('active-count').textContent = active;
            const tBar = document.getElementById('tasks-bar');
            tBar.style.width = active > 0 ? '100%' : '0%';

            renderTimers();
        }

        function renderTimers() {
            if (timers.length === 0) {
                tContainer.innerHTML = '';
                tEmpty.classList.remove('hidden');
                return;
            }
            tEmpty.classList.add('hidden');
            
            tContainer.innerHTML = timers.map(t => {
                const percent = Math.max(0, (t.remaining / t.totalSeconds) * 100);
                const isDone = t.isFinished;
                const statusClass = isDone ? 'bg-red-500/10 border-red-500/30' : 'bg-dark-card border-dark-border';
                const progressColor = isDone ? 'bg-red-500' : 'bg-blue-500';

                const fmtDuration = (sec) => {
                    const h = Math.floor(sec / 3600);
                    const m = Math.floor((sec % 3600) / 60);
                    const s = sec % 60;
                    return h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
                };

                return `
                <div class="relative ${statusClass} border rounded-xl p-4 overflow-hidden transition-all group hover:border-slate-500 pr-12">
                    <div class="absolute bottom-0 left-0 h-1 ${progressColor} transition-all duration-1000 opacity-60" style="width: ${percent}%"></div>
                    
                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex items-center gap-4 overflow-hidden flex-1">
                            <div class="w-12 h-12 flex-shrink-0 rounded-xl ${isDone ? 'bg-red-500/20' : 'bg-blue-500/10'} flex items-center justify-center border border-white/5">
                                ${isDone ? '<i data-lucide="bell" class="w-6 h-6 text-red-500 animate-bounce"></i>' : '<i data-lucide="timer" class="w-6 h-6 text-blue-400"></i>'}
                            </div>
                            <div class="min-w-0 flex flex-col justify-center">
                                <div class="font-medium text-xs text-dark-subtext truncate mb-1 uppercase tracking-wide flex items-center gap-1">
                                    ${t.label}
                                    ${t.hasDelay ? '<span class="text-[9px] text-amber-400 bg-amber-400/10 px-1 rounded border border-amber-400/20">BUFFER</span>' : ''}
                                </div>
                                <div class="font-mono font-bold ${isDone ? 'text-red-400' : 'text-white'} text-2xl sm:text-3xl leading-none tracking-tight">
                                    ${isDone ? 'TIME UP' : fmtDuration(t.remaining)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-end justify-center pl-4 border-l border-white/10">
                                <span class="text-[10px] font-bold text-dark-subtext uppercase tracking-wider mb-1">Ends At</span>
                                <span class="font-mono font-bold text-emerald-400 text-2xl sm:text-3xl leading-none">
                                    ${formatTime(t.endTime)}
                                </span>
                            </div>
                            
                            <button onclick="removeTimer(${t.id})" class="w-8 h-8 flex items-center justify-center border border-red-500/40 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all ml-1 shrink-0" title="Remove">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        document.getElementById('timer-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const label = document.getElementById('t-label').value.trim() || 'Task';
            const h = parseInt(inputH.value) || 0;
            const m = parseInt(inputM.value) || 0;
            const s = parseInt(inputS.value) || 0;
            
            const delayMin = parseInt(globalDelayInput.value) || 0;
            const inputSeconds = h * 3600 + m * 60 + s;
            const total = inputSeconds + (delayMin * 60);
            
            if (total <= 0) return;

            timers.push({
                id: Date.now(),
                label,
                endTime: new Date(new Date().getTime() + total * 1000),
                totalSeconds: total,
                remaining: total,
                isFinished: false,
                hasDelay: delayMin > 0
            });
            
            saveTimers();
            
            document.getElementById('t-label').value = '';
            inputH.value = '';
            inputM.value = '';
            inputS.value = '';
            inputH.focus();
            
            renderTimers();
        });

        window.removeTimer = (id) => {
            timers = timers.filter(t => t.id !== id);
            saveTimers();
            renderTimers();
        };

        // =======================
        // TRACKER LOGIC
        // =======================
        let trackerLinks = [];
        let editingId = null;
        let selectedTrackerIds = new Set(); 

        const listEl = document.getElementById('tracker-list');
        const modalEl = document.getElementById('tracker-modal');

        function initTracker() {
            const saved = localStorage.getItem('dashboard-tracker');
            if (saved) trackerLinks = JSON.parse(saved);
            
            const lastDate = localStorage.getItem('last-reset-date');
            const today = getTaipeiDate();
            
            // Daily Reset Logic
            if (lastDate !== today) {
                trackerLinks.forEach(l => {
                    l.clicks = 0;
                    l.executed = false; 
                });
                localStorage.setItem('last-reset-date', today);
                saveTracker();
            }
            renderTracker();
        }

        function saveTracker() {
            localStorage.setItem('dashboard-tracker', JSON.stringify(trackerLinks));
            renderTracker();
        }

        function checkScheduledTasks(now) {
            const currentHHMM = pad(now.getHours()) + ':' + pad(now.getMinutes());
            let updated = false;

            trackerLinks.forEach(link => {
                if (link.schedule && link.url && link.schedule === currentHHMM && !link.executed) {
                    console.log(`Auto-opening ${link.name} at ${currentHHMM}`);
                    
                    link.executed = true; 
                    link.clicks = (link.clicks || 0) + 1;
                    updated = true;

                    try {
                        const win = window.open(link.url.startsWith('http') ? link.url : 'https://' + link.url, '_blank');
                        if (!win || win.closed || typeof win.closed == 'undefined') {
                            popupWarning.classList.remove('hidden');
                        }
                    } catch (e) {
                        console.error(e);
                        popupWarning.classList.remove('hidden');
                    }
                }
            });

            if (updated) saveTracker();
        }

        // Toggle Selection for single item
        window.toggleTrackerSelection = (id) => {
            if (selectedTrackerIds.has(id)) {
                selectedTrackerIds.delete(id);
            } else {
                selectedTrackerIds.add(id);
            }
            // Update the UI logic for buttons
            renderTracker();
        };

        // NEW: Toggle Select All
        window.toggleSelectAll = () => {
            const allIds = trackerLinks.map(l => l.id);
            const allSelected = allIds.length > 0 && allIds.every(id => selectedTrackerIds.has(id));
            
            if (allSelected) {
                selectedTrackerIds.clear();
            } else {
                allIds.forEach(id => selectedTrackerIds.add(id));
            }
            renderTracker();
        };

        // NEW: Delete Selected
        window.deleteSelectedTasks = () => {
            if (selectedTrackerIds.size === 0) return;
            
            if (confirm(`確定刪除選取的 ${selectedTrackerIds.size} 筆任務？此動作無法復原。`)) {
                trackerLinks = trackerLinks.filter(l => !selectedTrackerIds.has(l.id));
                selectedTrackerIds.clear();
                saveTracker();
            }
        };

        window.copySelectedTasks = () => {
            if (selectedTrackerIds.size === 0) {
                alert('請先勾選任務');
                return;
            }

            const selectedItems = trackerLinks.filter(item => selectedTrackerIds.has(item.id));
            
            if (selectedItems.length === 0) return;

            const textToCopy = selectedItems.map(item => `${item.name}: ${item.url || 'No URL'}`).join('\n');

            if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(textToCopy).then(() => {
                    alert(`已複製 ${selectedItems.length} 筆資料到剪貼簿`);
                }).catch(err => {
                    console.warn('Modern clipboard API failed, trying fallback...', err);
                    fallbackCopyTextToClipboard(textToCopy, selectedItems.length);
                });
            } else {
                fallbackCopyTextToClipboard(textToCopy, selectedItems.length);
            }
        };

        function fallbackCopyTextToClipboard(text, count) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert(`已複製 ${count} 筆資料到剪貼簿`);
                } else {
                    alert('複製失敗');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('複製失敗，請手動複製');
            }
            document.body.removeChild(textArea);
        }

        // =======================
        // RESTORE LOGIC
        // =======================
        const restoreModalEl = document.getElementById('restore-modal');

        window.openRestoreModal = () => {
            document.getElementById('restore-input').value = '';
            restoreModalEl.classList.remove('hidden');
            setTimeout(() => document.getElementById('restore-input').focus(), 50);
            lucide.createIcons();
        };

        window.closeRestoreModal = () => {
            restoreModalEl.classList.add('hidden');
        };

        window.importTasks = () => {
            const text = document.getElementById('restore-input').value;
            if (!text.trim()) {
                closeRestoreModal();
                return;
            }

            const lines = text.split('\n');
            let importedCount = 0;

            for (let i = lines.length - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (!line) continue;

                const colonIndex = line.indexOf(':');
                let name, url;

                if (colonIndex !== -1) {
                    name = line.substring(0, colonIndex).trim();
                    url = line.substring(colonIndex + 1).trim();
                    if (url === 'No URL') url = '';
                } else {
                    name = line;
                    url = '';
                }

                if (name) {
                    trackerLinks.unshift({
                        id: Date.now() + Math.random(), 
                        name: name,
                        url: url,
                        clicks: 0,
                        executed: false,
                        schedule: null
                    });
                    importedCount++;
                }
            }

            saveTracker();
            closeRestoreModal();
            alert(`成功還原 ${importedCount} 筆任務`);
        };

        function renderTracker() {
            const empty = document.getElementById('tracker-empty');
            if(trackerLinks.length === 0) {
                listEl.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            // Determine Select All State
            const allIds = trackerLinks.map(l => l.id);
            const allSelected = allIds.length > 0 && allIds.every(id => selectedTrackerIds.has(id));
            const hasSelection = selectedTrackerIds.size > 0;

            // Update Select All Button Visuals
            const btnSelectAll = document.getElementById('btn-select-all');
            if (btnSelectAll) {
                 if (allSelected) {
                    btnSelectAll.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                    btnSelectAll.classList.remove('bg-dark-card', 'text-dark-subtext', 'border-dark-border');
                 } else {
                    btnSelectAll.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                    btnSelectAll.classList.add('bg-dark-card', 'text-dark-subtext', 'border-dark-border');
                 }
            }

            // Update Delete Button Visibility
            const btnDelete = document.getElementById('btn-delete-selected');
            if (btnDelete) {
                if (hasSelection) btnDelete.classList.remove('hidden');
                else btnDelete.classList.add('hidden');
            }

            listEl.innerHTML = trackerLinks.map((link, idx) => {
                const count = link.clicks || 0;
                const isSelected = selectedTrackerIds.has(link.id); 

                let dotsHtml = '';
                if(count > 0 && count <= 5) {
                    dotsHtml = Array(count).fill(`<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>`).join('');
                } else if (count > 5) {
                    dotsHtml = `<span class="text-xs font-mono font-bold text-emerald-400">${count} runs</span>`;
                } else {
                    dotsHtml = `<span class="text-[10px] text-dark-subtext uppercase font-bold opacity-50">Ready</span>`;
                }

                let scheduleHtml = '';
                if (link.schedule) {
                    const statusColor = link.executed ? 'text-dark-subtext opacity-50 line-through' : 'text-amber-400';
                    const iconColor = link.executed ? 'text-dark-subtext' : 'text-amber-400';
                    scheduleHtml = `
                        <div class="flex items-center gap-1.5 bg-dark-bg/50 px-2 py-1 rounded border border-white/5 ml-auto md:ml-0 md:mr-2">
                            <i data-lucide="clock" class="w-3 h-3 ${iconColor}"></i>
                            <span class="text-[10px] font-mono font-bold ${statusColor}">${link.schedule}</span>
                        </div>
                    `;
                }

                const upBtn = idx === 0 ? `<div class="w-4 h-4"></div>` : 
                    `<button onclick="moveTrackerUp(${idx})" class="text-dark-subtext hover:text-white"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>`;
                const downBtn = idx === trackerLinks.length - 1 ? `<div class="w-4 h-4"></div>` : 
                    `<button onclick="moveTrackerDown(${idx})" class="text-dark-subtext hover:text-white"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>`;

                return `
                <div class="group relative bg-dark-card border border-dark-border hover:border-slate-500 rounded-xl p-3 flex items-center gap-3 transition-all select-none shadow-sm">
                    
                    <div class="flex items-center justify-center pl-1 pr-2">
                        <input type="checkbox" class="custom-checkbox" 
                            onchange="toggleTrackerSelection(${link.id})" 
                            ${isSelected ? 'checked' : ''}>
                    </div>

                    <div class="flex flex-col gap-1 border-r border-white/5 pr-2">
                        ${upBtn}
                        ${downBtn}
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-0.5">
                            <h3 class="font-medium text-sm text-white truncate pr-2">${link.name}</h3>
                            ${scheduleHtml}
                        </div>
                        <div class="flex items-center gap-2 h-4">
                            ${dotsHtml}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="visitLink(${idx})" class="bg-blue-600/10 hover:bg-blue-600 hover:text-white text-blue-400 border border-blue-500/30 rounded-lg px-3 py-2 text-xs font-bold transition-all active:scale-95 flex items-center gap-1">
                            GO <i data-lucide="external-link" class="w-3 h-3"></i>
                        </button>
                        <div class="flex flex-col gap-1 border-l border-white/5 pl-2">
                            <button onclick="editTracker(${idx})" class="text-dark-subtext/60 hover:text-white p-1"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                            <button onclick="deleteTracker(${idx})" class="text-dark-subtext/60 hover:text-red-400 p-1"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        window.moveTrackerUp = (index) => {
            if (index <= 0) return;
            const item = trackerLinks[index];
            trackerLinks[index] = trackerLinks[index - 1];
            trackerLinks[index - 1] = item;
            saveTracker();
        };

        window.moveTrackerDown = (index) => {
            if (index >= trackerLinks.length - 1) return;
            const item = trackerLinks[index];
            trackerLinks[index] = trackerLinks[index + 1];
            trackerLinks[index + 1] = item;
            saveTracker();
        };

        window.visitLink = (idx) => {
            const link = trackerLinks[idx];
            link.clicks = (link.clicks || 0) + 1;
            saveTracker();
            
            if(link.url) {
                let targetUrl = link.url;
                if (!/^https?:\/\//i.test(targetUrl)) {
                    targetUrl = 'https://' + targetUrl;
                }
                const a = document.createElement('a');
                a.href = targetUrl;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        };

        window.openTrackerModal = () => {
            editingId = null;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="plus" class="w-5 h-5 text-emerald-400"></i><span>New Task</span>`;
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-url').value = '';
            document.getElementById('modal-schedule').value = ''; 
            modalEl.classList.remove('hidden');
            lucide.createIcons();
        };

        window.editTracker = (idx) => {
            editingId = idx;
            const item = trackerLinks[idx];
            document.getElementById('modal-title').innerHTML = `<i data-lucide="edit-3" class="w-5 h-5 text-blue-400"></i><span>Edit Task</span>`;
            document.getElementById('modal-name').value = item.name;
            document.getElementById('modal-url').value = item.url || '';
            document.getElementById('modal-schedule').value = item.schedule || ''; 
            modalEl.classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeTrackerModal = () => modalEl.classList.add('hidden');

        window.saveTrackerTask = () => {
            const name = document.getElementById('modal-name').value.trim();
            const rawUrl = document.getElementById('modal-url').value.trim();
            const schedule = document.getElementById('modal-schedule').value; 
            
            if(!name) return;

            const urlMatch = rawUrl.match(/(https?:\/\/[^\s]+)/);
            const cleanUrl = urlMatch ? urlMatch[0] : rawUrl;

            const taskData = {
                name,
                url: cleanUrl,
                schedule: schedule || null, 
            };

            if(editingId !== null) {
                trackerLinks[editingId] = { 
                    ...trackerLinks[editingId], 
                    ...taskData,
                    executed: (trackerLinks[editingId].schedule !== schedule) ? false : trackerLinks[editingId].executed
                };
            } else {
                trackerLinks.unshift({ 
                    id: Date.now(), 
                    ...taskData, 
                    clicks: 0,
                    executed: false
                });
            }
            saveTracker();
            closeTrackerModal();
        };

        window.deleteTracker = (idx) => {
            if(confirm('Delete this routine?')) {
                const deletedId = trackerLinks[idx].id;
                trackerLinks.splice(idx, 1);
                selectedTrackerIds.delete(deletedId); // cleanup selection
                saveTracker();
            }
        };

        initTracker();
        initTimers();
        setInterval(updateTimerLoop, 1000);
        
    </script>
</body>
</html>